rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Helper functions
    function isAuthenticated() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return request.auth.uid == userId;
    }

    function isAdmin() {
      // Check for the existence of the user document and the role field.
      // The role value is 'Admin' (case-sensitive).
      return exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
             get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'Admin';
    }

    // Users Collection
    match /users/{userId} {
      // A user can always read their own document to verify roles.
      allow read: if isOwner(userId) || isAdmin();
      // Users can only write to their own document. Admins can write to any.
      allow write: if isOwner(userId) || isAdmin();
      // Any authenticated user can create a user profile (e.g., during sign-up).
      allow create: if isAuthenticated();
      // Only admins can list all users.
      allow list: if isAdmin();
    }

    // Tasks Collection
    match /tasks/{taskId} {
        // Any authenticated user can read tasks.
        allow read: if isAuthenticated();

        // Users can create tasks if they are authenticated.
        allow create: if isAuthenticated();

        // Users can update a task if they are the creator, assigned to it, or an admin.
        allow update: if isAuthenticated() && (resource.data.createdBy == request.auth.uid || request.auth.uid in resource.data.assignedTo || isAdmin());

        // Users can delete a task if they are the creator or an admin.
        allow delete: if isAuthenticated() && (resource.data.createdBy == request.auth.uid || isAdmin());
    }

    // Conversations Collection
    match /conversations/{conversationId} {
      // A user can read a conversation if they are a participant or an admin.
      allow read: if (isAuthenticated() && request.auth.uid in resource.data.participants) || isAdmin();
      // A user can update a conversation if they are a participant.
      allow update: if isAuthenticated() && request.auth.uid in resource.data.participants;
      // A user can create a conversation if they are authenticated and are one of the participants.
      allow create: if isAuthenticated() && request.auth.uid in request.resource.data.participants;
      // Authenticated users can list conversations (client queries should filter by participant).
      allow list: if isAuthenticated();

      // Messages Subcollection
      match /messages/{messageId} {
        // A user can read messages if they are a participant of the parent conversation or an admin.
        allow read: if (isAuthenticated() && request.auth.uid in get(/databases/$(database)/documents/conversations/$(conversationId)).data.participants) || isAdmin();
        // A user can create a message if they are a participant of the parent conversation.
        allow create: if isAuthenticated() && request.auth.uid in get(/databases/$(database)/documents/conversations/$(conversationId)).data.participants;
        // A user can only update or delete a message if they are the sender.
        allow update, delete: if isAuthenticated() && resource.data.senderId == request.auth.uid;
      }
    }

    // Dashboard Metrics - Only admins can read.
    match /dashboard_metrics/{docId} {
      allow read, write: if isAdmin();
    }

    // News Collection - Allow authenticated users to read and write news.
    match /news/{docId} {
      allow read: if isAuthenticated();
      allow write: if isAdmin();
    }

    // Admins Collection - Allow users to read their own admin document for role verification.
    match /admins/{userId} {
      allow read: if isOwner(userId);
    }

    // Public Content - Any authenticated user can read.
    match /public_content/{docId} {
      allow read: if isAuthenticated();
    }

    // Generic user data subcollections
    match /user_data/{userId}/{collection}/{document} {
      allow read, write: if isOwner(userId);
    }

    // Test collection for development purposes
    match /test/{docId} {
        allow read, write: if isAuthenticated();
    }
  }
}